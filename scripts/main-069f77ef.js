"use strict";var app=angular.module("dashyAdmin",["ngMaterial","ngRoute","oauth"]).config(["$httpProvider",function(e){e.interceptors.push(["$q","$timeout",function(e,o){return function(t){var n=e.defer();return o(function(){t.then(function(e){n.resolve(e)})},5e3),n.promise}}])}]);app.service("LoaderService",function(){this.start=function(){$(".loader").removeClass("hidden")},this.stop=function(){$(".loader").addClass("hidden")}}),app.controller("ListDashboardsCtrl",["$scope","Api","LoaderService",function(e,o,t){e.isLoading=!0,e.$on("dashy:dashboards",function(n,s){t.start(),o.getUserDashboards(s).success(function(o){e.isLoading=!1,t.stop(),e.dashboards=o.dashboards&&0!==o.dashboards.length?o.dashboards:[]})}),e.$on("dashy:newDashboard",function(o,t){e.dashboards.push(t)})}]),app.controller("LoaderCtrl",["$scope","LoaderService",function(e,o){e.$on("oauth:login",function(){o.start()}),e.$on("oauth:loggedOut",function(){o.stop()}),e.$on("dashy:dashboards",function(){o.stop()})}]),app.controller("AddDeviceCtrl",["$scope","$mdDialog","Api","$rootScope",function(e,o,t,n){function s(e,o){e.error=0,e.hide=function(){o.hide()},e.close=function(){o.cancel()},e.addDevice=function(s){e.creatingDashboard=!0;var r=n.user.id;t.newDevice(r,s).success(function(t){e.error=0,e.creatingDashboard=0,n.$broadcast("dashy:newDashboard",t),o.hide()}).error(function(){e.creatingDashboard=0,e.error=1})}}e.show=!1,e.$on("oauth:loggedOut",function(){e.show=!1}),e.$on("dashy:dashboards",function(){e.show=!0}),e.showModalDevice=function(t){o.show({controller:s,templateUrl:"views/addDevice.html",targetEvent:t}).then(function(o){e.alert='You said the information was "'+o+'".'},function(){})}}]),angular.module("dashyAdmin").config(["$routeProvider",function(e){e.when("/dashboards",{templateUrl:"views/listDashboards.html",controller:"ListDashboardsCtrl"}).when("/dashboards/:dashboard",{templateUrl:"views/changeDashboard.html",controller:"ChangeDashboardCtrl"}).when("/access_token=:accessToken",{template:"",controller:function(e,o){var t=e.path().substr(1);o.setTokenFromString(t),e.path("/"),e.replace()}}).otherwise({redirectTo:"/",templateUrl:"views/login.html"})}]);var baseUrl="http://api.dashy.io";angular.module("dashyAdmin").factory("Api",["$http",function(e){return{getServerStatus:function(){return e.get(baseUrl+"/status")},getUserDashboards:function(o){return e.get(baseUrl+"/users/"+o)},newDevice:function(o,t){return e({method:"POST",headers:{"Content-Type":"application/json"},data:{code:t},url:baseUrl+"/users/"+o+"/dashboards"})},getDashboard:function(o){return e.get(baseUrl+"/dashboards"+o)},deleteDashboard:function(o){return e["delete"](baseUrl+"/dashboards"+o)},setDashboard:function(o){return e({method:"PUT",headers:{"Content-Type":"application/json"},data:{interval:o.interval,name:o.name,urls:o.urls},url:baseUrl+"/dashboards/"+o.id})},authenticateGoogleUser:function(o){return e.post(baseUrl+"/auth/google/login",{access_token:o.access_token})},getUser:function(){return e.get(baseUrl+"/user")},signupGoogleUser:function(o){return e.post(baseUrl+"/auth/google/signup",{access_token:o.access_token})}}}]),angular.module("dashyAdmin").service("AuthService",["$rootScope","Api","AccessToken","$http","$location","LoaderService",function(e,o,t,n,s,r){function a(e){l.loginStatus!==e&&(console.log("LoginService status: "+e),l.loginStatus=e)}function i(){o.getUser().success(function(o){l.user=o,console.log("getUser() GET ~/api/user success:",l.user),a("logged_in"),l.currentUser=u(l.user),r.stop(),e.isDashyLoggingIn=!1,e.user=l.currentUser,e.$broadcast("dashy:dashboards",l.user.id),s.path("/dashboards").replace()}).error(function(e,o){r.stop(),console.log("getUser() GET ~/api/user error:",e,o),a("logged_out")})}function u(e){return{id:e.id,name:e.profiles.google[0].displayName,imageUrl:e.profiles.google[0].image.url}}function c(e){o.signupGoogleUser(e).success(function(o){console.log("signupGoogleUser() POST ~/api/google/signup success:",o),l.authenticateGoogleUser(e)}).error(function(e,o){console.log("signupGoogleUser() POST ~/api/google/signup error:",e,o),a("logged_out")})}var l=this;l.loginStatus="",this.logout=function(){e.user=null,a("logged_out")},this.authenticateGoogleUser=function(){r.start();var s=t.get();o.authenticateGoogleUser(s).success(function(e){l.token=e.token,console.log("loginGoogleUser() POST ~/api/google/authenticate success:",l.token),l.existingUser!==!1&&(l.existingUser=!0),n.defaults.headers.common.Authorization="Bearer "+l.token,i()}).error(function(o,t){403===t?(console.log("loginGoogleUser() POST ~/api/google/authenticate user not signed up:",o,t),l.existingUser=!1,c(s)):(console.log("loginGoogleUser() POST ~/api/google/authenticate error:",o,t),a("logged_out"),e.$emit("userLoggedOut"))})}}]),angular.module("dashyAdmin").controller("AuthCtrl",["$scope","$timeout","AccessToken","AuthService","$rootScope",function(e,o,t,n,s){var r;e.$on("oauth:login",function(){console.log("logging in dashy 1"),s.isDashyLoggingIn=!0,n.authenticateGoogleUser(),r=!0}),o(function(){t.get()&&!r&&(console.log("logging in dashy 2"),s.isDashyLoggingIn=!0,n.authenticateGoogleUser())},0),e.$on("oauth:loggedOut",function(){n.logout()})}]);