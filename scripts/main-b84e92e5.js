"use strict";var dashyAdmin=angular.module("dashyAdmin",["ngStorage","ui.router"]);dashyAdmin.config(["$stateProvider","$urlRouterProvider",function(t,e){e.otherwise("/dashboards"),t.state("login",{url:"/login",views:{content:{templateUrl:"login.html",controller:"LoginCtrl"}},authenticate:!1}).state("dashboardsList",{url:"/dashboards",views:{content:{templateUrl:"dashboardList.html",controller:"MainCtrl"}},authenticate:!0}).state("dashboardEdit",{url:"/dashboards/:dashboardId",views:{content:{templateUrl:"dashboardEdit.html",controller:"DashboardCtrl"}},authenticate:!0})}]),dashyAdmin.run(["$rootScope","$state","authService",function(t,e,o){t.$on("$stateChangeStart",function(t,a){a.authenticate&&!o.isLoggedIn()&&(e.go("login"),t.preventDefault())})}]),dashyAdmin.factory("authService",["$localStorage",function(t){return{doLogIn:function(e){t.dashyUser=e},doLogOut:function(){delete t.dashyUser},isLoggedIn:function(){return t.dashyUser?!0:!1}}}]),dashyAdmin.factory("currentUser",function(){return{username:null,password:null}}),dashyAdmin.factory("api",["$http",function(t){return{getServerStatus:function(){return t.get("http://api.dashy.io/status")},getUserDashboards:function(e){return t.get("http://api.dashy.io/users/"+e)},newDevice:function(e,o){return t({method:"POST",headers:{"Content-Type":"application/json"},data:{shortCode:o},url:"http://api.dashy.io//users/"+e+"/claims/"})},getDashboard:function(e){return t.get("http://api.dashy.io/dashboards/"+e)},deleteDashboard:function(e){return t.delete("http://api.dashy.io/dashboards/"+e)},setDashboard:function(e){return t({method:"PUT",headers:{"Content-Type":"application/json"},data:{interval:e.interval,name:e.name,urls:e.urls},url:"http://api.dashy.io/dashboards/"+e.id})}}}]),dashyAdmin.controller("LoginCtrl",["$scope","$localStorage","$state","currentUser",function(t,e,o,a){t.user=a,t.$storage=e,t.$storage.dashyUser&&(t.user.isLoggedIn=!0),t.login=function(e){t.user=e,t.user.isLoggedIn=!0,t.$storage.dashyUser=e,o.go("dashboardsList")},t.logout=function(){delete t.$storage.dashyUser,t.user.isLoggedIn=!1,o.go("login")}}]),dashyAdmin.controller("ServerStatusCtrl",["$scope","api",function(t,e){var o=e.getServerStatus();o.success(function(e,o){t.serverStatus=o,$(".btn-newDevice").prop("disabled",!1)}).error(function(){t.serverStatus=0})}]),dashyAdmin.controller("NewDeviceCtrl",["$scope","api","$timeout",function(t,e,o){t.shortCode=null,t.validateShortCode=null,t.newDevice=function(){null===t.shortCode||6!==t.shortCode.length?t.validateShortCode=!1:(t.validateShortCode=!0,$(".btn-connectDevice").button("loading"),o(function(){$(".btn-connectDevice").button("reset"),$("#connectDevice").modal("hide"),t.shortCode="",t.validateShortCode=null},1500))}}]),dashyAdmin.controller("MainCtrl",["$scope","api","$localStorage",function(t,e,o){var a=e.getUserDashboards(o.dashyUser.username);a.success(function(o){o.dashboards.forEach(function(o){e.getDashboard(o).success(function(e){t.dashboards=[],t.dashboards.push(e)}).error(function(t){$.snackbar({content:'<i class="fa fa-3x fa-ban pull-left"></i>'+o+"<br>"+t.message,timeout:0})})})}).error(function(){t.dashboards=[],t.dashboardsError="Couldn't load your dashboards"}),t.deleteDashboard=function(t){window.confirm("Are you sure you want to delete your dashboard "+t.name)&&console.log("deleting "+t.id)}}]),dashyAdmin.controller("DashboardCtrl",["$scope","api","$stateParams",function(t,e,o){e.getDashboard(o.dashboardId).success(function(e){t.dashboard=e}),t.addUrl=function(){t.dashboard.urls.push("")},t.removeUrl=function(e){t.dashboard.urls.splice(e,1)},t.saveDashboard=function(t){$(".btn-save").button("loading"),$(".btn-save").prop("disabled",!0),e.setDashboard(t).success(function(){$.snackbar({content:"Your dashboard has been updated!"}),$(".btn-save").button("reset")}).error(function(t){window.alert("error updating: "+t)})}}]);